DEBUG - 2025-10-08 11:37:29 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:38:27 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:41:12 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:41:21 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:42:08 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:42:14 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:42:15 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:42:27 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
INFO - 2025-10-08 11:42:27 --> Login exitoso - Usuario: admision1, ID: 2, Rol: ADMISIONISTA
DEBUG - 2025-10-08 11:42:27 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:09 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
INFO - 2025-10-08 11:43:09 --> Logout - Usuario: admision1, ID: 2
DEBUG - 2025-10-08 11:43:09 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:32 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
INFO - 2025-10-08 11:43:32 --> Login exitoso - Usuario: administrador, ID: 1, Rol: ADMINISTRADOR
DEBUG - 2025-10-08 11:43:32 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:36 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:37 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:38 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:38 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
INFO - 2025-10-08 11:43:38 --> üîç DEBUG PABLO - Construyendo query con where: fu.seccion IN ('ME', 'ES')
INFO - 2025-10-08 11:43:38 --> üîç DEBUG PABLO - Par√°metros: []
INFO - 2025-10-08 11:43:38 --> üîç Ejecutando query modificaciones con par√°metros: []
INFO - 2025-10-08 11:43:38 --> Query completo: 
        SELECT
            fu.ate_codigo,
            fu.usu_id,
            fu.seccion,
            fu.fecha,
            fu.modificaciones_permitidas,
            fu.modificaciones_usadas,
            fu.habilitado_por_admin,
            fu.motivo_habilitacion,
            fu.fecha_habilitacion,

            -- Datos del paciente
            p.pac_nombres,
            p.pac_apellidos,
            p.pac_cedula,
            p.pac_his_cli,

            -- Datos de la atenci√≥n
            a.ate_fecha,
            a.ate_hora,

            -- Datos del profesional que complet√≥
            u.usu_nombre,
            u.usu_apellido,
            r.rol_nombre,

            -- Datos del admin que habilit√≥ (si aplica)
            admin.usu_nombre as admin_nombre,
            admin.usu_apellido as admin_apellido,

            -- CORREGIDO: Determinar si puede modificar - L√ìGICA COMPLETA
            CASE
                WHEN fu.modificaciones_usadas >= fu.modificaciones_permitidas THEN 0  -- NO puede si ya alcanz√≥ el l√≠mite
                WHEN fu.habilitado_por_admin = 1 THEN 1  -- S√ç puede si est√° habilitado por admin
                WHEN fu.modificaciones_usadas < fu.modificaciones_permitidas THEN 1  -- S√ç puede si tiene modificaciones restantes
                ELSE 0
            END as puede_modificar,

            -- CORREGIDO: Motivo del bloqueo si aplica
            CASE
                WHEN fu.modificaciones_usadas >= fu.modificaciones_permitidas THEN 'L√≠mite de modificaciones alcanzado (3/3)'
                WHEN fu.habilitado_por_admin = 1 THEN 'Habilitado por administrador'
                WHEN fu.modificaciones_usadas < fu.modificaciones_permitidas THEN 'Puede modificar naturalmente'
                ELSE 'Sin modificaciones disponibles'
            END as motivo_bloqueo,

            -- NUEVO: Estado para el bot√≥n del admin
            CASE
                WHEN fu.modificaciones_usadas >= fu.modificaciones_permitidas THEN 'BLOQUEADO'
                WHEN fu.habilitado_por_admin = 1 THEN 'HABILITADO'
                ELSE 'PUEDE_HABILITAR'
            END as estado_boton_admin,

            -- Informaci√≥n del √∫ltimo usuario que modific√≥
            CONCAT(u.usu_nombre, ' ', u.usu_apellido) as ultimo_usuario,
            fu.fecha as fecha_ultima_modificacion,

            -- Contador de modificaciones
            fu.modificaciones_usadas as modificaciones_count,

            -- Tipo de profesional
            CASE
                WHEN fu.seccion = 'ME' THEN 'M√©dico de Triaje'
                WHEN fu.seccion = 'ES' THEN 'M√©dico Especialista'
                ELSE 'Otro'
            END as tipo_profesional

        FROM t_formulario_usuario fu
        JOIN t_atencion a ON fu.ate_codigo = a.ate_codigo
        JOIN t_paciente p ON a.pac_codigo = p.pac_codigo
        JOIN t_usuario u ON fu.usu_id = u.usu_id
        JOIN t_rol r ON u.rol_id = r.rol_id
        LEFT JOIN t_usuario admin ON fu.admin_que_habilito = admin.usu_id

        WHERE fu.seccion IN ('ME', 'ES')

        ORDER BY
            fu.habilitado_por_admin DESC,  -- Modificaciones habilitadas primero
            fu.fecha DESC
        
INFO - 2025-10-08 11:43:38 --> ‚úÖ Query ejecutado exitosamente. Registros obtenidos: 0
INFO - 2025-10-08 11:43:38 --> üîç DEBUG TODOS LOS REGISTROS - Total: 0
DEBUG - 2025-10-08 11:43:38 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:39 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
DEBUG - 2025-10-08 11:43:39 --> Session: Class initialized using 'CodeIgniter\Session\Handlers\FileHandler' driver.
